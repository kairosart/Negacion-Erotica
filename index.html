<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tragaperras Negaci√≥n Er√≥tica</title>
<style>
  body { background: #111; color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; text-align: center; padding: 20px; }
  button { padding: 10px 16px; margin: 5px; border: none; border-radius: 8px; background: #0af; color: #111; font-weight: 700; cursor: pointer; }
  button:disabled { background: #555; color: #ccc; cursor: not-allowed; }
  #slotContainer { display: flex; justify-content: center; margin-top: 20px; }
  .cell { width: 82px; height: 82px; background: #222; border-radius: 8px; margin: 0 6px; display: flex; justify-content: center; align-items: center; font-size: 42px; }
  #resultadoTirada { font-size: 2em; font-weight: bold; margin-top: 20px; }
  .premio { color: #4caf50; }
  .sinPremio { color: #f44336; }
  #estadoJuego { margin-bottom: 20px; max-width: 760px; margin-left: auto; margin-right: auto; color: #fff; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; text-align: left; }
  #msgIntento { color: #ff5252; font-weight: bold; font-size: 1.05em; margin-bottom: 8px; text-align: center; }
  #historialBox { background: #222; padding: 10px; border-radius: 10px; font-size: 14px; color: #eee; max-height: 240px; overflow-y: auto; }
  #historialBox h3 { margin-top: 0; font-weight: bold; text-align: center; }
  #historialDetalles div { margin: 4px 0; }
  .premio-especial { background-color: #ffe55c; color: #000; font-weight: bold; padding: 2px 4px; border-radius: 4px; }
  #calendario { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 12px; }
  .dia { background: #333; padding: 8px; border-radius: 6px; }
  .jugado { background: #0af; color: #111; font-weight: bold; }
  table { margin: 20px auto; border-collapse: collapse; min-width: 320px; }
  th, td { border: 1px solid #0af; padding: 6px 10px; }
  th { background: #0af; color: #111; }
  #calendarioBox { display: none; }
</style>
</head>
<body>
<h1>üé∞ Negaci√≥n Er√≥tica</h1>

<div id="estadoJuego">
  <p id="msgIntento"></p>
  <p>√öltimo d√≠a jugado: <span id="ultimoDiaTxt"></span></p>
  <p>Racha: <span id="rachaTxt"></span> d√≠as</p>
  <p>Progreso actual: <span id="progresoTxt"></span>%</p>

  <div id="historialBox">
    <h3>Historial de d√≠as</h3>
    <div id="historialDetalles"></div>
  </div>
</div>

<div id="slotContainer">
  <div class="cell" id="c0">üçí</div>
  <div class="cell" id="c1">üçã</div>
  <div class="cell" id="c2">üîî</div>
</div>

<div id="resultadoTirada">üëâ Esperando tirada...</div>

<br />

<button id="spinBtn">üé∞ Girar</button>
<button id="verVideoBtn">üé• Ver video no atractivo (+5)</button>
<button id="verReglasBtn">üìú Ver Reglas</button>
<button id="toggleCalendarioBtn">üìÖ Mostrar/Ocultar Calendario</button>
<button id="reiniciarBtn">üîÑ Reiniciar</button>

<div id="calendarioBox">
  <h3>üìÖ Calendario de progreso</h3>
  <div id="calendario"></div>
</div>

<h3>üèÜ Tabla de Premios</h3>
<table id="tablaPremios">
  <tr><th>Combinaci√≥n</th><th>Premio</th></tr>
</table>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const calendarioBox = document.getElementById("calendarioBox");

  const cells = [0,1,2].map(i => document.getElementById("c"+i));
  const resultadoDiv = document.getElementById("resultadoTirada");
  const historialDiv = document.getElementById("historialDetalles");
  const calendarioDiv = document.getElementById("calendario");
  const tablaPremios = document.getElementById("tablaPremios");

  const spinBtn = document.getElementById("spinBtn");
  const verVideoBtn = document.getElementById("verVideoBtn");
  const verReglasBtn = document.getElementById("verReglasBtn");
  const toggleCalendarioBtn = document.getElementById("toggleCalendarioBtn");
  const reiniciarBtn = document.getElementById("reiniciarBtn");

  /* === FECHAS === */
  function formatoBonito(fechaISO){
    const [y,m,d] = fechaISO.split("-");
    return `${d}/${m}/${y}`;
  }

  function hoyISO(){
    const d=new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  /* === Estado === */
  const symbolsBase = ["üçí","üçã","üîî","üíé"];

  const premios = {
    "üçíüçíüçí": "Arruinado en 1 min.",
    "üçãüçãüçã": "Arruinado en 3 min.",
    "üîîüîîüîî": "Arruinado en 5 min.",
    "üíéüíéüíé": "Arruinado en 10 min.",
    "‚≠ê‚≠ê‚≠ê": "Modo especial: üéâ Mega premio!"
  };

  let ultimoDia = localStorage.getItem("ultimoDia") || "";
  let ultimoVideo = localStorage.getItem("ultimoVideo") || "";  // NUEVO
  let racha = parseInt(localStorage.getItem("racha")||"0");
  let historial = JSON.parse(localStorage.getItem("historialDias")||"[]");
  let premiosEspecialesPost20 = parseInt(localStorage.getItem("premiosEspecialesPost20")||"0");
  let progreso = parseInt(localStorage.getItem("progreso")||"50");

  function guardar(){
    localStorage.setItem("ultimoDia", ultimoDia);
    localStorage.setItem("ultimoVideo", ultimoVideo);   // NUEVO
    localStorage.setItem("racha", racha);
    localStorage.setItem("premiosEspecialesPost20", premiosEspecialesPost20);
    localStorage.setItem("historialDias", JSON.stringify(historial));
    localStorage.setItem("progreso", progreso);
  }

  /* === Render === */
  function renderHistorial(){
    historialDiv.innerHTML = historial.map(h => {
      const cls = h.especial ? 'premio-especial' : '';
      return `<div class="${cls}">üìÖ ${formatoBonito(h.fecha)}: ${h.texto}</div>`;
    }).join("");
  }

  function actualizarEstadoJuego(){
    const hoy = hoyISO();
    const yaJugo = ultimoDia === hoy;
    const yaVideo = ultimoVideo === hoy;

    document.getElementById("msgIntento").textContent = yaJugo ? "Hoy ya usaste tu intento." : "";
    document.getElementById("ultimoDiaTxt").textContent = ultimoDia ? formatoBonito(ultimoDia) : "Ninguno";
    document.getElementById("rachaTxt").textContent = racha;
    document.getElementById("progresoTxt").textContent = progreso;

    spinBtn.disabled = yaJugo;
    verVideoBtn.disabled = yaVideo; // NUEVO
  }

  function renderCalendario(){
    calendarioDiv.innerHTML = "";
    const now=new Date();
    const year=now.getFullYear();
    const month=now.getMonth();
    const diasEnMes=new Date(year,month+1,0).getDate();

    for(let i=1;i<=diasEnMes;i++){
      const fechaISO = `${year}-${String(month+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
      const jugado = historial.some(h=>h.fecha===fechaISO);
      calendarioDiv.innerHTML += `<div class="dia ${jugado?'jugado':''}">${i}</div>`;
    }
  }

  function actualizarTablaPremios(){
    tablaPremios.innerHTML="<tr><th>Combinaci√≥n</th><th>Premio</th></tr>";
    Object.entries(premios).forEach(([c,p])=>{
      tablaPremios.innerHTML+=`<tr><td>${c}</td><td>${p}</td></tr>`;
    });
  }

  /* === L√≥gica === */
  function addHistorial(texto, especial=false){
    historial.push({ fecha: hoyISO(), texto, especial });
    renderHistorial();
    actualizarEstadoJuego();
    renderCalendario();
    guardar();
  }

  function getSymbol(){ return symbolsBase[Math.floor(Math.random()*symbolsBase.length)]; }

  function getSymbolsModoEspecial(){
    let p=0.05;
    if(racha>=25)p=0.10;
    if(racha>=30)p=0.15;
    if(racha>=35)p=0.20;

    let arr=[0,0,0].map(()=>Math.random()<p?"‚≠ê":getSymbol());

    if(racha>=20 && premiosEspecialesPost20<3){
      if(!arr.includes("‚≠ê")) arr[Math.floor(Math.random()*3)]="‚≠ê";
      premiosEspecialesPost20++;
    }
    return arr;
  }

  function getTripleOrRandom(){
    if(Math.random()<0.25){
      const s=getSymbol();
      return [s,s,s];
    }
    return [getSymbol(),getSymbol(),getSymbol()];
  }

  function girarRodillos(finalArr,onFinish){
    let spins=15, count=0;
    const int=setInterval(()=>{
      cells.forEach(c=>c.textContent=getSymbol());
      if(++count>=spins){
        clearInterval(int);
        cells.forEach((c,i)=>c.textContent=finalArr[i]);
        onFinish();
      }
    },80);
  }

  /* === EVENTOS === */

  // üé∞ GIRAR
  spinBtn.addEventListener("click", ()=>{
    if(ultimoDia===hoyISO()) return;

    let s=[0,0,0], especial=false;
    if(racha>=20){
      s=getSymbolsModoEspecial();
      especial = s.every(x=>x==="‚≠ê");
    } else {
      s=getTripleOrRandom();
    }

    girarRodillos(s, ()=>{
      const nombre = premios[s.join("")] || "Sin premio";

      resultadoDiv.textContent = nombre;
      resultadoDiv.className = nombre==="Sin premio" ? "sinPremio" : "premio";

      racha++;
      ultimoDia=hoyISO();
      spinBtn.disabled=true;

      addHistorial(`Tirada: ${nombre}`, especial);
    });
  });


  // üé• VIDEO NO ATRACTIVO (solo 1 vez por d√≠a)
  verVideoBtn.addEventListener("click", ()=>{
    const hoy = hoyISO();

    if (ultimoVideo === hoy) {
      alert("Solo puedes ver el video no atractivo una vez por d√≠a.");
      return;
    }

    progreso = Math.min(100, progreso + 5);
    ultimoVideo = hoy;

    addHistorial("Video visto (+5%)");
    verVideoBtn.disabled = true;

    guardar();
  });

  // üìú REGLAS
  verReglasBtn.addEventListener("click", ()=>{
    alert("Reglas:\n- 1 tirada por d√≠a.\n- 1 video no atractivo por d√≠a.\n- Racha diaria.\n- Modo especial ‚≠ê desde 20 d√≠as.\n- Ganar: 3 s√≠mbolos iguales.");
  });

  // üìÖ MOSTRAR/OCULTAR CALENDARIO
  toggleCalendarioBtn.addEventListener("click", ()=>{
    calendarioBox.style.display = calendarioBox.style.display==="none" ? "block":"none";
  });

  // üîÑ REINICIAR
  reiniciarBtn.addEventListener("click", ()=>{
    if(!confirm("¬øReiniciar todo?"))return;

    localStorage.clear();

    ultimoDia="";
    ultimoVideo=""; // NUEVO
    racha=0;
    historial=[];
    premiosEspecialesPost20=0;
    progreso=50;

    resultadoDiv.textContent="üëâ Esperando tirada...";
    resultadoDiv.className="";

    renderHistorial();
    actualizarEstadoJuego();
    renderCalendario();
    actualizarTablaPremios();

    alert("Reiniciado.");
  });

  /* === Render inicial === */
  renderHistorial();
  actualizarEstadoJuego();
  renderCalendario();
  actualizarTablaPremios();

});
</script>
</body>
</html>
