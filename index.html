<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tragaperras NegaciÃ³n ErÃ³tica</title>
<style>
  body { background: #111; color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; text-align: center; padding: 20px; }
  button { padding: 10px 16px; margin: 5px; border: none; border-radius: 8px; background: #0af; color: #111; font-weight: 700; cursor: pointer; }
  button:disabled { background: #555; color: #ccc; cursor: not-allowed; }
  #slotContainer { display: flex; justify-content: center; margin-top: 20px; }
  .cell { width: 82px; height: 82px; background: #222; border-radius: 8px; margin: 0 6px; display: flex; justify-content: center; align-items: center; font-size: 42px; }
  #resultadoTirada { font-size: 2em; font-weight: bold; margin-top: 20px; }
  .ganaste { color: #4caf50; }   /* verde */
  .negacion { color: #f44336; }  /* rojo */
  #estadoJuego { margin-bottom: 20px; max-width: 760px; margin-left: auto; margin-right: auto; color: #fff; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; text-align: left; }
  #msgIntento { color: #ff5252; font-weight: bold; font-size: 1.05em; margin-bottom: 8px; text-align: center; }
  #historialBox { background: #222; padding: 10px; border-radius: 10px; font-size: 14px; color: #eee; max-height: 240px; overflow-y: auto; }
  #historialBox h3 { margin-top: 0; font-weight: bold; text-align: center; }
  #historialDetalles div { margin: 4px 0; }
  .premio-especial { background-color: #ffe55c; color: #000; font-weight: bold; padding: 2px 4px; border-radius: 4px; }
  #calendario { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 12px; }
  .dia { background: #333; padding: 8px; border-radius: 6px; }
  .jugado { background: #0af; color: #111; font-weight: bold; }
  table { margin: 20px auto; border-collapse: collapse; min-width: 320px; }
  th, td { border: 1px solid #0af; padding: 6px 10px; }
  th { background: #0af; color: #111; }
  #calendarioBox { display: none; } /* oculto por defecto */
</style>
</head>
<body>
<h1>ğŸ° NegaciÃ³n ErÃ³tica</h1>

<div id="estadoJuego">
  <p id="msgIntento"></p>
  <p>Ãšltimo dÃ­a jugado: <span id="ultimoDiaTxt"></span></p>
  <p>Racha: <span id="rachaTxt"></span> dÃ­as</p>
  <p>Progreso actual: <span id="progresoTxt"></span>%</p>

  <div id="historialBox">
    <h3>Historial de dÃ­as</h3>
    <div id="historialDetalles"></div>
  </div>
</div>

<div id="slotContainer">
  <div class="cell" id="c0">ğŸ’</div>
  <div class="cell" id="c1">ğŸ‹</div>
  <div class="cell" id="c2">ğŸ””</div>
</div>

<div id="resultadoTirada">ğŸ‘‰ Esperando tirada...</div>

<br />

<button id="spinBtn">ğŸ° Girar</button>
<button id="verVideoBtn">ğŸ¥ Ver video no atractivo (+5)</button>
<button id="verReglasBtn">ğŸ“œ Ver Reglas</button>
<button id="toggleCalendarioBtn">ğŸ“… Mostrar/Ocultar Calendario</button>
<button id="reiniciarBtn">ğŸ”„ Reiniciar</button>

<div id="calendarioBox">
  <h3>ğŸ“… Calendario de progreso</h3>
  <div id="calendario"></div>
</div>

<h3>ğŸ† Tabla de Premios</h3>
<table id="tablaPremios">
  <tr><th>CombinaciÃ³n</th><th>Premio</th></tr>
</table>

<script>
/* ===== Referencias UI ===== */
const cells = [0,1,2].map(i => document.getElementById("c"+i));
const resultadoDiv = document.getElementById("resultadoTirada");
const historialDiv = document.getElementById("historialDetalles");
const calendarioDiv = document.getElementById("calendario");
const tablaPremios = document.getElementById("tablaPremios");

/* ===== ConfiguraciÃ³n del juego ===== */
const symbolsBase = ["ğŸ’","ğŸ‹","ğŸ””","ğŸ’"];
const premios = {
  "ğŸ’ğŸ’ğŸ’": "Arruinado en 1 min.",
  "ğŸ‹ğŸ‹ğŸ‹": "Arruinado en 3 min.",
  "ğŸ””ğŸ””ğŸ””": "Arruinado en 5 min.",
  "ğŸ’ğŸ’ğŸ’": "Arruinado en 10 min.",
  "â­â­â­": "Modo especial: ğŸ‰ Mega premio!"
};

/* ===== Estado persistente ===== */
let ultimoDia = localStorage.getItem("ultimoDia") || "";
let racha = parseInt(localStorage.getItem("racha")) || 0;
let historial = JSON.parse(localStorage.getItem("historialDias") || "[]");
let premiosEspecialesPost20 = parseInt(localStorage.getItem("premiosEspecialesPost20") || "0");
let progreso = parseInt(localStorage.getItem("progreso")) || 50; // 0-100

function hoy(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function guardar(){
  localStorage.setItem("ultimoDia", ultimoDia);
  localStorage.setItem("racha", racha);
  localStorage.setItem("premiosEspecialesPost20", premiosEspecialesPost20);
  localStorage.setItem("historialDias", JSON.stringify(historial));
  localStorage.setItem("progreso", progreso);
}

/* ===== Render UI ===== */
function renderHistorial(){
  historialDiv.innerHTML = historial.map(h => {
    const cls = h.especial ? 'premio-especial' : '';
    return `<div class="${cls}">ğŸ“… ${h.fecha}: ${h.texto}</div>`;
  }).join("");
}

function actualizarEstadoJuego(){
  document.getElementById("msgIntento").textContent = (ultimoDia===hoy()) ? "Hoy ya usaste tu intento." : "";
  document.getElementById("ultimoDiaTxt").textContent = ultimoDia || "Ninguno";
  document.getElementById("rachaTxt").textContent = racha;
  document.getElementById("progresoTxt").textContent = progreso;
}

function renderCalendario(){
  calendarioDiv.innerHTML = "";
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const diasEnMes = new Date(year, month+1, 0).getDate();
  for(let i=1;i<=diasEnMes;i++){
    const fStr = `${year}-${String(month+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    const jugado = historial.some(h=>h.fecha===fStr);
    calendarioDiv.innerHTML += `<div class="dia ${jugado?'jugado':''}">${i}</div>`;
  }
}

function actualizarTablaPremios(){
  tablaPremios.innerHTML = "<tr><th>CombinaciÃ³n</th><th>Premio</th></tr>";
  Object.entries(premios).forEach(([combo,premio])=>{
    tablaPremios.innerHTML += `<tr><td>${combo}</td><td>${premio}</td></tr>`;
  });
}

/* InicializaciÃ³n */
renderHistorial();
actualizarEstadoJuego();
renderCalendario();
actualizarTablaPremios();

/* ===== LÃ³gica de sÃ­mbolos ===== */
function getSymbol(){ return symbolsBase[Math.floor(Math.random()*symbolsBase.length)]; }

function getSymbolsModoEspecial(){
  let probEstrella = 0.05;
  if(racha>=25) probEstrella = 0.10;
  if(racha>=30) probEstrella = 0.15;
  if(racha>=35) probEstrella = 0.20;
  const symbols = [];
  for(let i=0;i<3;i++){ symbols.push(Math.random()<probEstrella ? "â­" : getSymbol()); }
  // GarantÃ­a parcial: primeras 3 tiradas tras racha >=20 aseguran al menos una â­ si no saliÃ³
  if(racha>=20 && premiosEspecialesPost20<3){
    if(!symbols.includes("â­")) symbols[Math.floor(Math.random()*3)] = "â­";
    premiosEspecialesPost20++;
  }
  return symbols;
}

function getTripleOrRandom(){
  // Sesgo suave 25% hacia triple para reducir negaciÃ³n
  if(Math.random()<0.25){
    const s = getSymbol();
    return [s,s,s];
  }
  return [getSymbol(),getSymbol(),getSymbol()];
}

/* ===== AnimaciÃ³n de rodillos ===== */
function girarRodillos(finalSymbols, onFinish){
  let spins = 15, count = 0;
  const interval = setInterval(()=>{
    cells.forEach(c=>c.textContent = getSymbol());
    count++;
    if(count>=spins){
      clearInterval(interval);
      cells.forEach((c,i)=>c.textContent = finalSymbols[i]);
      if(typeof onFinish==="function") onFinish();
    }
  },80);
}

/* ===== Utilidades ===== */
function mostrarResultado(symbols){
  const gano = (symbols[0]===symbols[1] && symbols[1]===symbols[2]);
  if(gano){
    resultadoDiv.textContent = "ğŸ‰ Â¡Ganaste!";
    resultadoDiv.className = "ganaste";
  } else {
    resultadoDiv.textContent = "âŒ NegaciÃ³n";
    resultadoDiv.className = "negacion";
  }
}

function addHistorial(texto, especial=false){
  historial.push({ fecha:hoy(), texto, especial });
  renderHistorial();
  actualizarEstadoJuego();
  renderCalendario();
  guardar();
}

/* ===== Eventos ===== */
document.getElementById("spinBtn").addEventListener("click", ()=>{
  if(ultimoDia===hoy()){ alert("Solo 1 tirada por dÃ­a."); return; }

  let s1, s2, s3, esEspecial = false;
  if(racha>=20){
    [s1,s2,s3] = getSymbolsModoEspecial();
    esEspecial = (s1==="â­" && s2==="â­" && s3==="â­");
  } else {
    [s1,s2,s3] = getTripleOrRandom();
  }

  const symbolsFinal = [s1,s2,s3];

  girarRodillos(symbolsFinal, ()=>{
    mostrarResultado(symbolsFinal);
    const gano = (s1===s2 && s2===s3);
    racha++;
    ultimoDia = hoy();
    addHistorial(`Tirada: ${gano ? "ğŸ‰ Ganaste!" : "âŒ NegaciÃ³n"}`, esEspecial);
  });
});

document.getElementById("verVideoBtn").addEventListener("click", ()=>{
  progreso = Math.min(100, progreso + 5);
  addHistorial("Video visto (+5%)");
});

document.getElementById("verReglasBtn").addEventListener("click", ()=>{
  alert(
    "Reglas:\n"+
    "- Solo 1 tirada por dÃ­a.\n"+
    "- La racha aumenta en +1 cada dÃ­a que juegas.\n"+
    "- Si no juegas un dÃ­a, la racha se rompe.\n"+
    "- Racha 20 dÃ­as activa el modo especial (â­ con prob. creciente y garantÃ­a parcial al inicio).\n"+
    "- Ganar: los 3 sÃ­mbolos deben ser iguales.\n"+
    "- Premios: ğŸ’ğŸ’ğŸ’=1min, ğŸ‹ğŸ‹ğŸ‹=3min, ğŸ””ğŸ””ğŸ””=5min, ğŸ’ğŸ’ğŸ’=10min, â­â­â­=Mega premio.\n"+
    "- Ver video no atractivo: +5% de Progreso actual.\n"
  );
});

document.getElementById("toggleCalendarioBtn").addEventListener("click", ()=>{
  const box = document.getElementById("calendarioBox");
  const visible = box.style.display !== "none";
  box.style.display = visible ? "none" : "block";
});

document.getElementById("reiniciarBtn").addEventListener("click", ()=>{
  if(!confirm("Se reiniciarÃ¡ todo el progreso. Â¿Continuar?")) return;
  localStorage.clear();
  // Reset estado
  ultimoDia = "";
  racha = 0;
  historial = [];
  premiosEspecialesPost20 = 0;
  progreso = 50;
  // Reset UI
  resultadoDiv.textContent = "ğŸ‘‰ Esperando tirada...";
  resultadoDiv.className = "";
  renderHistorial();
  actualizarEstadoJuego();
  renderCalendario();
  actualizarTablaPremios();
  alert("Todo reiniciado.");
});
</script>
</body>
</html>
