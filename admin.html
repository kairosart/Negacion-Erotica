<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tragaperras NegaciÃ³n ErÃ³tica</title>
<style>
  :root{
    --accent:#0af;
    --bg:#111;
    --panel:#222;
    --text:#fff;
    --green:#0f0;
    --red:#f55;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial;}
  .wrap{max-width:900px;margin:18px auto;padding:12px;}
  h1{margin:6px 0 14px;text-align:center;}
  #estadoJuego{display:flex;flex-direction:column;align-items:center;margin-bottom:12px;font-family:monospace;}
  #estadoJuego p{margin:4px 0;}
  #slotContainer{display:flex;justify-content:center;gap:10px;margin-top:8px;}
  .cell{width:80px;height:80px;background:var(--panel);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:40px;box-shadow:0 2px 6px rgba(0,0,0,0.6);}
  #resultadoTirada{font-size:26px;margin-top:12px;min-height:36px;font-weight:700;text-align:center;}
  .premio-verde{color:var(--green);}
  .premio-rojo{color:var(--red);}
  .controls{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
  button{padding:10px 16px;margin:5px;border:none;border-radius:8px;background:#0af;color:#fff;font-weight:bold;cursor:pointer;}
  button:disabled{background:#555;cursor:not-allowed;}
  #historialBox{background:var(--panel);padding:12px;border-radius:10px;margin-top:20px;color:#eee;max-height:260px;overflow:auto;}
  #historialBox h3{margin:0 0 8px 0;text-align:center;}
  .premio-especial{background:yellow;color:#000;padding:2px 6px;border-radius:6px;font-weight:700;}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.68);backdrop-filter:blur(3px);align-items:center;justify-content:center;z-index:3000;}
  .modal.show{display:flex;}
  .modal-card{background:var(--panel);color:var(--text);padding:18px;border-radius:12px;border:2px solid var(--accent);box-shadow:0 8px 30px rgba(0,0,0,0.6);max-width:92%;width:520px;max-height:86%;overflow:auto;position:relative;}
  .modal-close{position:absolute;right:12px;top:10px;font-size:22px;cursor:pointer;color:var(--accent);}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{border:1px solid var(--accent);padding:8px;text-align:left;}
  th{background:var(--accent);color:#001;}
  #videoEl{width:100%;height:auto;border-radius:8px;background:#000;display:block;}
  @media (max-width:520px){.cell{width:64px;height:64px;font-size:34px} #resultadoTirada{font-size:20px}}
</style>
</head>
<body>

<div class="wrap">
  <h1>ğŸ° NegaciÃ³n ErÃ³tica</h1>

  <div id="estadoJuego">
    <p>Fecha: <span id="fechaTxt">--/--/----</span></p>
    <p>Racha: <span id="rachaTxt">0</span> dÃ­as</p>
    <p>Probabilidad actual: <span id="probTxt">0.00</span>%</p>
  </div>

  <div id="slotContainer">
    <div class="cell" id="c0">ğŸ’</div>
    <div class="cell" id="c1">ğŸ‹</div>
    <div class="cell" id="c2">ğŸ””</div>
  </div>

  <div id="resultadoTirada">ğŸ‘‰ Esperando tirada...</div>

  <div class="controls">
    <button id="spinBtn">ğŸ° Girar</button>
    <button id="verVideoBtn">ğŸ¥ Ver video no atractivo (+5%)</button>
    <button id="verTablaBtn">ğŸ“œ Ver Tabla de Premios</button>
    <button id="verReglasBtn">ğŸ“˜ Ver Reglas</button>
    <button id="reiniciarBtn">ğŸ”„ Reiniciar</button>
  </div>

  <div id="historialBox">
    <h3>Historial de dÃ­as</h3>
    <div id="historialDetalles"></div>
  </div>
</div>

<div id="videoModal" class="modal">
  <div class="modal-card" role="dialog" aria-modal="true" aria-label="Video bonus">
    <span id="videoClose" class="modal-close">&times;</span>
    <video id="videoEl" controls>
      <source src="video.mp4" type="video/mp4">
      Tu navegador no soporta video.
    </video>
  </div>
</div>

<div id="tablaModal" class="modal">
  <div class="modal-card" role="dialog" aria-modal="true" aria-label="Tabla de premios">
    <span id="tablaClose" class="modal-close">&times;</span>
    <h2>ğŸ† Tabla de Premios</h2>
    <div id="tablaPremiosInner"></div>
  </div>
</div>

<!-- PREMIOS EXTERNOS -->
<script src="premios.js"></script>

<script>
const cells=[0,1,2].map(i=>document.getElementById('c'+i));
const resultadoDiv=document.getElementById('resultadoTirada');
const historialDiv=document.getElementById('historialDetalles');
const fechaTxt=document.getElementById('fechaTxt');
const rachaTxt=document.getElementById('rachaTxt');
const probTxt=document.getElementById('probTxt');
const spinBtn=document.getElementById('spinBtn');
const verVideoBtn=document.getElementById('verVideoBtn');

let symbolsBase=["ğŸ’","ğŸ‹","ğŸ””","ğŸ’","â­"]; // sÃ­mbolos base
// premios viene del fichero premios.js

let prob=parseFloat(localStorage.getItem('prob'))||50;
let ultimoDia=localStorage.getItem('ultimoDia')||'';
let racha=parseInt(localStorage.getItem('racha'))||0;
let historial=JSON.parse(localStorage.getItem('historialDias')||'[]');
let premiosEspecialesPost20=parseInt(localStorage.getItem('premiosEspecialesPost20')||'0');
let ultimoVideoDia=localStorage.getItem('ultimoVideoDia')||'';

function hoy(){
  const d=new Date();
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const yyyy=d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

function guardar(){
  localStorage.setItem('prob',prob);
  localStorage.setItem('ultimoDia',ultimoDia);
  localStorage.setItem('racha',racha);
  localStorage.setItem('historialDias',JSON.stringify(historial));
  localStorage.setItem('premiosEspecialesPost20',premiosEspecialesPost20);
  localStorage.setItem('ultimoVideoDia',ultimoVideoDia);
}

function actualizarEstado(){
  fechaTxt.textContent=hoy();
  rachaTxt.textContent=racha;
  probTxt.textContent=prob.toFixed(2);
}

function actualizarBotones(){
  spinBtn.disabled = (ultimoDia===hoy());
  verVideoBtn.disabled = (ultimoVideoDia===hoy());
}

function renderHistorial(){
  historialDiv.innerHTML=historial.map(h=>{
    const cls=(h.texto.includes("â­â­â­"))?'premio-especial':'';
    return `<div class="${cls}">ğŸ“… ${h.fecha}: ${h.texto}</div>`;
  }).join('');
}

function addHistorial(texto){
  historial.push({fecha:hoy(),texto});
  renderHistorial();
  guardar();
}

function getSymbol(){ return symbolsBase[Math.floor(Math.random()*symbolsBase.length)]; }

function getSymbolsModoEspecial(){
  if(racha<20) return [getSymbol(),getSymbol(),getSymbol()];
  let probEstrella=0;
  if(racha>=25) probEstrella=0.1;
  if(racha>=30) probEstrella=0.15;
  if(racha>=35) probEstrella=0.2;
  let symbols=[];
  for(let i=0;i<3;i++) symbols.push(Math.random()<probEstrella?"â­":getSymbol());
  if(premiosEspecialesPost20<3 && !symbols.includes("â­")){ symbols[Math.floor(Math.random()*3)]="â­"; premiosEspecialesPost20++; }
  return symbols;
}

function girarRodillos(finalSymbols,onFinish){
  let spins=15,count=0;
  const interval=setInterval(()=>{
    cells.forEach(c=>c.textContent=getSymbol());
    count++;
    if(count>=spins){ clearInterval(interval); cells.forEach((c,i)=>c.textContent=finalSymbols[i]); if(onFinish) onFinish(); }
  },80);
}

spinBtn.addEventListener('click',()=>{
  if(ultimoDia===hoy()){ alert('Solo 1 tirada por dÃ­a.'); return; }
  let s1,s2,s3;
  if(racha>=20){ [s1,s2,s3]=getSymbolsModoEspecial(); } else { [s1,s2,s3]=[getSymbol(),getSymbol(),getSymbol()]; }

  girarRodillos([s1,s2,s3],()=>{
    const combo=s1+s2+s3;
    let premioTexto="Sin premio", hayPremio=false;
    if(s1===s2 && s2===s3){ premioTexto=premios[combo]||"ğŸ‰ Ganaste!"; hayPremio=true; prob+=0.2; }
    else if(s1===s2){ premioTexto=premios[s1+s2]||"Premio doble!"; hayPremio=true; prob+=0.1; }
    else if(s2===s3){ premioTexto=premios[s2+s3]||"Premio doble!"; hayPremio=true; prob+=0.1; }
    else{ prob-=0.05; }

    prob=Math.min(Math.max(prob,0),100);
    racha++; ultimoDia=hoy();
    resultadoDiv.textContent=premioTexto;
    resultadoDiv.className=hayPremio?'premio-verde':'premio-rojo';
    addHistorial(`Tirada: ${combo} â€” ${premioTexto}`);
    actualizarEstado();
    actualizarBotones();
  });
});

// Video modal
const videoModal=document.getElementById('videoModal');
const videoEl=document.getElementById('videoEl');
const videoClose=document.getElementById('videoClose');

verVideoBtn.addEventListener('click',()=>{
  if(ultimoVideoDia===hoy()){ alert('Ya viste el video hoy.'); return; }
  videoModal.classList.add('show'); videoModal.setAttribute('aria-hidden','false');
  videoEl.currentTime=0; videoEl.play();
});

videoClose.addEventListener('click',()=>{
  videoEl.pause(); videoModal.classList.remove('show'); videoModal.setAttribute('aria-hidden','true');
  if(ultimoVideoDia!==hoy()){ prob=Math.min(prob+5,100); ultimoVideoDia=hoy(); addHistorial('Video visto (+5%)'); actualizarEstado(); actualizarBotones(); guardar(); }
});

videoEl.addEventListener('ended',()=>{
  videoModal.classList.remove('show'); videoModal.setAttribute('aria-hidden','true');
  if(ultimoVideoDia!==hoy()){ prob=Math.min(prob+5,100); ultimoVideoDia=hoy(); addHistorial('Video visto (+5%)'); actualizarEstado(); actualizarBotones(); guardar(); }
});

videoModal.addEventListener('click',(e)=>{ if(e.target===videoModal) videoClose.click(); });

// Tabla de premios
const tablaModal=document.getElementById('tablaModal');
const tablaInner=document.getElementById('tablaPremiosInner');
const tablaClose=document.getElementById('tablaClose');

document.getElementById('verTablaBtn').addEventListener('click',()=>{
  let html='<table><tr><th>CombinaciÃ³n</th><th>Premio</th></tr>';
  Object.entries(premios).forEach(([k,v])=>{ html+=`<tr><td>${k}</td><td>${v}</td></tr>`; });
  html+='</table>'; tablaInner.innerHTML=html;
  tablaModal.classList.add('show'); tablaModal.setAttribute('aria-hidden','false');
});
tablaClose.addEventListener('click',()=>{ tablaModal.classList.remove('show'); tablaModal.setAttribute('aria-hidden','true'); });
tablaModal.addEventListener('click',(e)=>{ if(e.target===tablaModal) tablaClose.click(); });

// Reglas
document.getElementById('verReglasBtn').addEventListener('click',()=>{
  alert(
    "Reglas:\n"+
    "- Solo 1 tirada por dÃ­a.\n"+
    "- Racha +1 cada dÃ­a que juegas.\n"+
    "- Racha 20 dÃ­as activa modo especial (â­).\n"+
    "- Ganar: triple igual.\n"+
    "- Dobles solo si estÃ¡n juntos.\n"+
    "- Probabilidad sube al ganar (+0.2) y al ver video (+5), baja al perder (âˆ’0.05).\n"+
    "- Video bonus: una vez al dÃ­a, +5%."
  );
});

// Reiniciar
document.getElementById('reiniciarBtn').addEventListener('click',()=>{
  if(!confirm('Se reiniciarÃ¡ todo el progreso. Â¿Continuar?')) return;
  localStorage.clear(); historial=[]; prob=50; racha=0; ultimoDia=''; premiosEspecialesPost20=0; ultimoVideoDia='';
  resultadoDiv.textContent='ğŸ‘‰ Esperando tirada...'; resultadoDiv.className='';
  renderHistorial(); actualizarEstado(); actualizarBotones();
});

// Inicializar
actualizarEstado(); renderHistorial(); actualizarBotones();
resultadoDiv.textContent='ğŸ‘‰ Esperando tirada...';
</script>
</body>
</html>
