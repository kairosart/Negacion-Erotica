<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Negaci√≥n Er√≥tica Test</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="premios.js"></script>

<style>
  body { background: #111; color: #fff; font-family: system-ui; text-align: center; padding: 20px; }
  button { padding: 10px 16px; margin: 5px; border: none; border-radius: 8px; background: #0af; color: #fff; font-weight: bold; cursor: pointer; }
  button:disabled { background: #555; cursor: not-allowed; }
  #slotContainer { display: flex; justify-content: center; margin-top: 20px; }
  .cell { width: 80px; height: 80px; background: #222; border-radius: 8px; margin: 0 5px; display: flex; justify-content: center; align-items: center; font-size: 40px; transition: transform 0.3s; }
  canvas { background: #111; margin-top: 10px; border-radius: 8px; }
  table { margin: 10px auto; border-collapse: collapse; }
  th, td { border: 1px solid #0af; padding: 6px 10px; }
  th { background: #0af; color: #111; }
  #estadoJuego { margin-bottom: 20px; max-width: 700px; margin-left: auto; margin-right: auto; color: #fff; font-family: monospace; text-align: left; }
  #msgIntento { color: #ff5252; font-weight: bold; font-size: 1.1em; margin-bottom: 8px; text-align: center; }
  #historialBox { background: #222; padding: 10px; border-radius: 10px; font-size: 14px; color: #eee; max-height: 220px; overflow-y: auto; }
  #historialBox h3 { margin-top: 0; font-weight: bold; text-align: center; }
  .premio-especial { background-color: yellow; color: #000; font-weight: bold; padding: 2px 4px; border-radius: 4px; }

  /* Modal */
  #tablaModal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    display: none;
    justify-content: center;
    align-items: center;
  }
  #tablaModal.show { display: flex !important; }
  #tablaModal .modal-content {
    background: #222;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 520px;
    position: relative;
  }
  #tablaClose {
    position: absolute;
    top: 8px;
    right: 8px;
    background: red;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>üé∞ Negaci√≥n Er√≥tica Test</h1>

<div id="estadoJuego">
  <p id="msgIntento"></p>
  <p>√öltimo d√≠a jugado: <span id="ultimoDiaTxt"></span></p>
  <p>Racha: <span id="rachaTxt"></span> d√≠as</p>
  <p>Probabilidad actual: <span id="probabilidadTxt"></span>%</p>

  <div id="historialBox">
    <h3>Historial de d√≠as</h3>
    <div id="historialDetalles"></div>
  </div>
</div>

<div id="slotContainer">
  <div class="cell" id="c0">üçí</div>
  <div class="cell" id="c1">üçã</div>
  <div class="cell" id="c2">üîî</div>
</div>

<div id="resultadoTirada">üëâ Esperando tirada...</div>

<br />

<button id="spinBtn">üé∞ Girar</button>
<button id="verVideoBtn">üé• Ver video no atractivo (+5%)</button>
<button id="verReglasBtn">üìú Ver Reglas</button>
<button id="simularBtn">üß™ Simular 365 d√≠as</button>
<button id="verTablaBtn">üèÜ Ver Premios</button>
<button id="reiniciarBtn">üîÑ Reiniciar</button>

<h3>Frecuencia de premios</h3>
<canvas id="premiosCanvas" width="700" height="320"></canvas>

<h3>Evoluci√≥n de ‚ÄúProbabilidad actual‚Äù</h3>
<canvas id="probabilidadCanvas" width="700" height="180"></canvas>


<!-- Modal Premios -->
<div id="tablaModal" aria-hidden="true">
  <div class="modal-content">
    <button id="tablaClose">X</button>
    <h2>Premios</h2>
    <div id="tablaPremiosInner"></div>
  </div>
</div>

<script>
/* =========================
   Estado y persistencia
========================= */
const cells = [0,1,2].map(i => document.getElementById("c"+i));
const historialDiv = document.getElementById("historialDetalles");
const tablaPremios = document.getElementById("tablaPremios");
const resultadoTirada = document.getElementById("resultadoTirada");

let symbolsBase = ["üçí","üçã","üîî","üíé","‚≠ê"];
let prob = parseFloat(localStorage.getItem("prob")) || 50;
let ultimoDia = localStorage.getItem("ultimoDia") || "";
let racha = parseInt(localStorage.getItem("racha")) || 0;
let historial = JSON.parse(localStorage.getItem("historialDias")||"[]");
let premiosEspecialesPost20 = parseInt(localStorage.getItem("premiosEspecialesPost20")||"0");
let probHistorial = JSON.parse(localStorage.getItem("probHistorial")||"[]");
let combinaciones = JSON.parse(localStorage.getItem("combinaciones")||"{}");

function hoy(){ return new Date().toISOString().split("T")[0]; }
function guardar(){
  localStorage.setItem("prob",prob);
  localStorage.setItem("ultimoDia",ultimoDia);
  localStorage.setItem("racha",racha);
  localStorage.setItem("premiosEspecialesPost20",premiosEspecialesPost20);
  localStorage.setItem("historialDias",JSON.stringify(historial));
  localStorage.setItem("probHistorial",JSON.stringify(probHistorial));
  localStorage.setItem("combinaciones",JSON.stringify(combinaciones));
}

/* =========================
   UI y gr√°ficos
========================= */
function addHistorial(texto, especial=false){
  historial.push({ fecha:hoy(), texto, especial});
  renderHistorial();
  actualizarEstadoJuego();
  guardar();
}

function renderHistorial(){
  historialDiv.innerHTML = historial
    .map(h => `<div class="${h.especial ? 'premio-especial' : ''}">üìÖ ${h.fecha}: ${h.texto}</div>`)
    .join("");
}

function actualizarTablaPremios(){
  tablaPremios.innerHTML = "<tr><th>Combinaci√≥n</th><th>Premio</th></tr>";
  Object.entries(premios).forEach(([combo,premio])=>{
    tablaPremios.innerHTML += `<tr><td>${combo}</td><td>${premio}</td></tr>`;
  });
}

let probChart, premiosChart;

function contarPremios() {
  const conteoPremios = {};
  Object.values(premios).forEach(p => { conteoPremios[p]=0; });
  historial.forEach(h=>{
    Object.entries(premios).forEach(([combo,premio])=>{
      if(h.texto.includes(combo)) conteoPremios[premio]++;
    });
  });
  return conteoPremios;
}

function actualizarGraficoPremios() {
  const ctx = document.getElementById("premiosCanvas").getContext("2d");
  const conteo = contarPremios();
  const labels = Object.keys(conteo);
  const data = Object.values(conteo);

  // Colores: amarillo si la etiqueta incluye "orgasmo", azul normal para los dem√°s
  const backgroundColors = labels.map(label => {
    return label.toLowerCase().includes("orgasmo") ? "#ff0" : "#0af";
  });

  if(premiosChart) premiosChart.destroy();
  premiosChart = new Chart(ctx,{
    type:"bar",
    data:{ labels, datasets:[{label:"Veces que sali√≥", data, backgroundColor: backgroundColors}]},
    options:{
      plugins:{ legend:{ display:false }},
      scales:{
        x:{ title:{display:true,text:"Premios"}, grid:{display:true,color:"#444"}},
        y:{ beginAtZero:true, title:{display:true,text:"Cantidad"}, grid:{display:true,color:"#444"}}
      }
    }
  });
}


// ============================
// Gr√°fico probabilidad
// ============================
function actualizarGraficoProbabilidad(){
  const ctx = document.getElementById("probabilidadCanvas").getContext("2d");
  const labels = probHistorial.map((_,i)=>i+1);
  const data = probHistorial.map(v => v);

  const pointColors = data.map((v,i)=>{
    const h = historial[i];
    return h && h.texto.toLowerCase().includes("orgasmo") ? "#ff0" : "#0af";
  });

  if(probChart) probChart.destroy();
  probChart = new Chart(ctx,{
    type:"line",
    data:{
      labels: labels,
      datasets:[{
        label:"Probabilidad actual (%)",
        data: data,
        borderColor:"#0af",
        pointBackgroundColor: pointColors,
        fill:false
      }]
    },
    options:{ plugins:{ legend:{ display:true } } }
  });
}

function actualizarGraficoProbabilidad(){
  const ctx = document.getElementById("probabilidadCanvas").getContext("2d");
  if(probChart) probChart.destroy();
  probChart = new Chart(ctx,{
    type:"line",
    data:{
      labels:probHistorial.map((_,i)=>i+1),
      datasets:[{label:"Probabilidad actual (%)", data:probHistorial, borderColor:"#0af", fill:false}]
    },
    options: { plugins: { legend: { display: true } } }
  });
}


function actualizarEstadoJuego(){
  document.getElementById("msgIntento").textContent = (ultimoDia===hoy()) ? "Hoy ya usaste tu intento." : "";
  document.getElementById("ultimoDiaTxt").textContent = ultimoDia||"Ninguno";
  document.getElementById("rachaTxt").textContent = racha;
  document.getElementById("probabilidadTxt").textContent = prob.toFixed(2);
}

/* =========================
   S√≠mbolos y Modo Especial
========================= */
function getSymbol(){ return symbolsBase[Math.floor(Math.random()*symbolsBase.length)]; }

function getSymbolsModoEspecial(){
    if(racha < 20) return [getSymbol(), getSymbol(), getSymbol()];

    let symbols = [];
    let probEstrella = 0;
    if(racha >= 25) probEstrella = 0.10;
    if(racha >= 30) probEstrella = 0.15;
    if(racha >= 35) probEstrella = 0.20;

    for(let i=0;i<3;i++){ symbols.push(Math.random()<probEstrella ? "‚≠ê" : getSymbol()); }

    if(premiosEspecialesPost20 < 3 && !symbols.includes("‚≠ê")){
        symbols[Math.floor(Math.random()*3)]="‚≠ê";
        premiosEspecialesPost20++;
    }

    return symbols;
}

/* =========================
   Animaci√≥n
========================= */
function girarRodillos(finalSymbols, onFinish){
  let spins=15, count=0;
  const interval = setInterval(()=>{
    cells.forEach(c=>c.textContent=getSymbol());
    count++;
    if(count>=spins){
      clearInterval(interval);
      cells.forEach((c,i)=>c.textContent=finalSymbols[i]);
      if(onFinish) onFinish();
    }
  }, 80);
}

/* =========================
   Girar
========================= */
document.getElementById("spinBtn").addEventListener("click", ()=>{
  if(ultimoDia === hoy()){ alert("Solo 1 tirada por d√≠a."); return; }

  let s1, s2, s3, esEspecial = false;
  if(racha >= 20){ [s1, s2, s3] = getSymbolsModoEspecial(); esEspecial = (s1==="‚≠ê" && s2==="‚≠ê" && s3==="‚≠ê"); }
  else { [s1, s2, s3] = [getSymbol(), getSymbol(), getSymbol()]; }

  const combo = s1 + s2 + s3;
  combinaciones[combo] = (combinaciones[combo] || 0) + 1;

  let premioTexto = "‚ùå Negaci√≥n";
  if(s1===s2 && s2===s3){ premioTexto=premios[combo] || "üéâ Ganaste!"; prob+=0.2; }
  else if(s1===s2){ premioTexto=premios[s1+s2] || "Premio doble!"; prob+=0.1; }
  else if(s2===s3){ premioTexto=premios[s2+s3] || "Premio doble!"; prob+=0.1; }
  else{ prob -= 0.05; }

  resultadoTirada.textContent = "üé∞ Girando...";

  girarRodillos([s1,s2,s3], ()=>{
    resultadoTirada.textContent = premioTexto;
    addHistorial(`Tirada: ${combo} ${premioTexto}`, esEspecial);
    prob = Math.min(Math.max(prob,0),100);
    probHistorial.push(prob);
    racha++; ultimoDia=hoy();
    actualizarGraficoProbabilidad();
    actualizarGraficoPremios();
    actualizarEstadoJuego();
    guardar();
  });
});

/* =========================
   Ver video
========================= */
document.getElementById("verVideoBtn").addEventListener("click",()=>{
  prob=Math.min(prob+5,100);
  probHistorial.push(prob);
  addHistorial("Video visto (+5%)");
  actualizarGraficoProbabilidad();
  actualizarEstadoJuego();
  guardar();
});

/* =========================
   Modal Premios
========================= */
const tablaModal = document.getElementById('tablaModal');
const tablaInner = document.getElementById('tablaPremiosInner');
const tablaClose = document.getElementById('tablaClose');

document.getElementById('verTablaBtn').addEventListener('click',()=>{
  let html='<table><tr><th>Combinaci√≥n</th><th>Premio</th></tr>';
  Object.entries(premios).forEach(([k,v])=>{html+=`<tr><td>${k}</td><td>${v}</td></tr>`;});
  html+='</table>';
  tablaInner.innerHTML = html;
  tablaModal.classList.add('show');
  tablaModal.setAttribute('aria-hidden','false');
});

tablaClose.addEventListener('click',()=>{
  tablaModal.classList.remove('show');
  tablaModal.setAttribute('aria-hidden','true');
});

tablaModal.addEventListener('click',(e)=>{
  if(e.target===tablaModal) tablaClose.click();
});

/* =========================
   Reglas
========================= */
document.getElementById("verReglasBtn").addEventListener("click",()=>{
  alert(
    "Reglas:\n"+
    "- Solo 1 tirada permitida por d√≠a.\n"+
    "- La racha incrementa en +1 cada d√≠a que juegas.\n"+
    "- Racha 20 d√≠as activa modo especial (s√≠mbolo ‚≠ê).\n"+
    "- Ganar: triple igual. Dobles solo si est√°n juntos.\n"+
    "- La 'Probabilidad actual' sube al ganar (+0.2) y al ver el video (+5), baja al perder (‚àí0.05)."
  );
});

/* =========================
   Simulaci√≥n 365 d√≠as
========================= */
document.getElementById("simularBtn").addEventListener("click",()=>{
  if(!confirm("Esto simular√° 365 tiradas autom√°ticamente. ¬øContinuar?")) return;

  let rachaReal = racha;
  let probReal = prob;
  let premiosPost20 = premiosEspecialesPost20;

  for(let d=0; d<365; d++){
    let rachaSim = rachaReal + d;
    let s1, s2, s3, esEspecial = false;
    if(rachaSim >= 20){ [s1,s2,s3] = getSymbolsModoEspecial(); esEspecial = (s1==="‚≠ê" && s2==="‚≠ê" && s3==="‚≠ê"); }
    else { [s1,s2,s3] = [getSymbol(), getSymbol(), getSymbol()]; }

    const combo = s1+s2+s3;
    let premioTexto = "‚ùå Negaci√≥n";
    if(s1===s2 && s2===s3){ premioTexto=premios[combo] || "üéâ Ganaste!"; probReal += 0.2; }
    else if(s1===s2){ premioTexto=premios[s1+s2] || "Premio doble!"; probReal += 0.1; }
    else if(s2===s3){ premioTexto=premios[s2+s3] || "Premio doble!"; probReal += 0.1; }
    else { probReal -= 0.05; }

    probReal = Math.min(Math.max(probReal,0),100);
    probHistorial.push(probReal);
    historial.push({fecha:`Sim D√≠a ${d+1}`, texto:`Tirada: ${combo} ${premioTexto}`, especial: esEspecial});
  }

  racha = rachaReal;
  prob = prob;
  premiosEspecialesPost20 = premiosPost20;

  guardar();
  renderHistorial();
  actualizarGraficoProbabilidad();
  actualizarGraficoPremios();
  actualizarEstadoJuego();
  alert("Simulaci√≥n completada sin afectar tu progreso real!");
});

/* =========================
   Reinicio total
========================= */
document.getElementById("reiniciarBtn").addEventListener("click",()=>{
  if(!confirm("Se reiniciar√° todo el progreso. ¬øContinuar?")) return;
  localStorage.clear();
  historial=[]; combinaciones={}; probHistorial=[]; racha=0; premiosEspecialesPost20=0; prob=50; ultimoDia="";
  renderHistorial();
  actualizarGraficoProbabilidad();
  actualizarGraficoPremios();
  actualizarEstadoJuego();
});

/* =========================
   Inicializaci√≥n
========================= */
actualizarTablaPremios();
renderHistorial();
actualizarGraficoProbabilidad();
actualizarGraficoPremios();
actualizarEstadoJuego();
</script>

</body>
</html>
