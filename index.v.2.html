<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tragaperras NegaciÃ³n ErÃ³tica</title>
<style>
:root{
  --accent:#0af; --bg:#111; --panel:#222; --text:#fff; --green:#0f0; --red:#f55;
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial;}
.wrap{max-width:900px;margin:18px auto;padding:12px;}
h1{margin:6px 0 14px;text-align:center;}
#estadoJuego{text-align:center;margin-bottom:12px;font-family:monospace;}
#estadoJuego p{margin:4px 0;}
#slotContainer{display:flex;justify-content:center;gap:10px;margin-top:8px;}
.cell{width:80px;height:80px;background:var(--panel);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:40px;box-shadow:0 2px 6px rgba(0,0,0,0.6);}
#resultadoTirada{font-size:26px;margin-top:12px;min-height:36px;font-weight:700;text-align:center;}
.premio-verde{color:var(--green);}
.premio-rojo{color:var(--red);}
.controls{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
button { padding: 10px 16px; border: none; border-radius: 8px; background: #0af; color: #fff; font-weight: bold; cursor: pointer; }
button:disabled { background: #555; cursor: not-allowed; }
#historialBox{background:var(--panel);padding:12px;border-radius:10px;margin-top:20px;color:#eee;max-height:260px;overflow:auto;}
#historialBox h3{margin:0 0 8px 0;text-align:center;}
.premio-especial{background:yellow;color:#000;padding:2px 6px;border-radius:6px;font-weight:700;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.68);backdrop-filter:blur(3px);align-items:center;justify-content:center;z-index:3000;}
.modal.show{display:flex;}
.modal-card{background:var(--panel);color:var(--text);padding:18px;border-radius:12px;border:2px solid var(--accent);box-shadow:0 8px 30px rgba(0,0,0,0.6);max-width:92%;width:520px;max-height:86%;overflow:auto;}
.modal-close{position:absolute;right:12px;top:10px;font-size:22px;cursor:pointer;color:var(--accent);}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid var(--accent);padding:8px;text-align:left;}
th{background:var(--accent);color:#001;}
#videoEl{width:100%;height:auto;border-radius:8px;}
#panelTest{display:none;background:#333;color:#0f0;padding:12px;border-radius:10px;margin-top:20px;max-height:200px;overflow:auto;}
@media (max-width:520px){.cell{width:64px;height:64px;font-size:34px} #resultadoTirada{font-size:20px}}
#toggleTestBtn{position:fixed;bottom:10px;right:10px;z-index:5000;padding:8px 12px;background:#0af;color:#fff;border:none;border-radius:6px;}
</style>
</head>
<body>
<div class="wrap">
<h1>ğŸ° NegaciÃ³n ErÃ³tica</h1>

<div id="estadoJuego">
  <p>Fecha: <span id="fechaTxt">--/--/----</span></p>
  <p>Racha: <span id="rachaTxt">0</span> dÃ­as</p>
  <p>Probabilidad actual: <span id="probTxt">0.00</span>%</p>
</div>

<div id="slotContainer">
  <div class="cell" id="c0">ğŸ’</div>
  <div class="cell" id="c1">ğŸ‹</div>
  <div class="cell" id="c2">ğŸ””</div>
  <div class="cell" id="c3">1</div>
</div>

<div id="resultadoTirada">ğŸ‘‰ Esperando tirada...</div>

<div class="controls">
  <button id="spinBtn">ğŸ° Girar</button>
  <button id="verVideoBtn">ğŸ¥ Ver video (+5%)</button>
  <button id="verTablaBtn">ğŸ“œ Ver Tabla de Premios</button>
  <button id="verReglasBtn">ğŸ“˜ Ver Reglas</button>
  <button id="reiniciarBtn">ğŸ”„ Reiniciar</button>
  <button id="exportCsvBtn">ğŸ’¾ Exportar CSV</button>
</div>

<div id="historialBox">
  <h3>Historial de dÃ­as</h3>
  <div id="historialDetalles"></div>
</div>

<div id="panelTest">
  <h3>ğŸ“Š Panel de EstadÃ­sticas Test</h3>
  <div id="estadisticasTest"></div>
</div>

</div>

<button id="toggleTestBtn">ğŸ”§ Test</button>

<div id="videoModal" class="modal">
  <div class="modal-card">
    <span id="videoClose" class="modal-close">&times;</span>
    <video id="videoEl" controls>
      <source src="video.mp4" type="video/mp4">
      Tu navegador no soporta video.
    </video>
  </div>
</div>

<div id="tablaModal" class="modal">
  <div class="modal-card">
    <span id="tablaClose" class="modal-close">&times;</span>
    <h2>ğŸ† Tabla de Premios</h2>
    <div id="tablaPremiosInner"></div>
  </div>
</div>

<script src="premios.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{

const cells = [0,1,2,3].map(i=>document.getElementById('c'+i));
const resultadoDiv = document.getElementById('resultadoTirada');
const historialDiv = document.getElementById('historialDetalles');
const fechaTxt = document.getElementById('fechaTxt');
const rachaTxt = document.getElementById('rachaTxt');
const probTxt = document.getElementById('probTxt');
const panelTest = document.getElementById('panelTest');
const estadisticasTest = document.getElementById('estadisticasTest');

let symbolsBase = ["ğŸ’","ğŸ‹","ğŸ””","ğŸ’","â­"];
let prob = parseFloat(localStorage.getItem('prob')) || 50;
let racha = parseInt(localStorage.getItem('racha')) || 0;
let historial = JSON.parse(localStorage.getItem('historialDias') || '[]');
let premiosEspecialesPost20 = parseInt(localStorage.getItem('premiosEspecialesPost20') || '0');
let ultimoDia = localStorage.getItem('ultimoDia') || '';
let ultimoVideoDia = localStorage.getItem('ultimoVideoDia') || '';

let ultimosDobles = []; // historial de Ãºltimos 5 tiradas para limitar dobles

function hoy(){
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

function guardar(){
  localStorage.setItem('prob', prob);
  localStorage.setItem('racha', racha);
  localStorage.setItem('historialDias', JSON.stringify(historial));
  localStorage.setItem('premiosEspecialesPost20', premiosEspecialesPost20);
  localStorage.setItem('ultimoDia', ultimoDia);
  localStorage.setItem('ultimoVideoDia', ultimoVideoDia);
}

function actualizarEstado(){
  fechaTxt.textContent = hoy();
  rachaTxt.textContent = racha;
  probTxt.textContent = prob.toFixed(2);
  actualizarPanelTest();
}

function renderHistorial(){
  historialDiv.innerHTML = historial.slice().reverse().map(h=>{
    const cls = h.especial ? 'premio-especial' : '';
    return `<div class="${cls}">ğŸ“… ${h.fecha}: ${h.texto}</div>`;
  }).join('');
}

function addHistorial(texto, especial=false){
  historial.push({fecha:hoy(), texto, especial});
  renderHistorial();
  guardar();
  actualizarPanelTest();
}

function actualizarPanelTest(){
  const total = historial.length;
  const triples = historial.filter(h=>h.texto.includes("Triple")).length;
  const dobles = historial.filter(h=>h.texto.includes("doble")).length;
  const sin = total - triples - dobles;
  estadisticasTest.innerHTML = `
    Total: ${total} | Triples: ${triples} | Dobles: ${dobles} | Sin premio: ${sin}
  `;
}

function getSymbol(){ return symbolsBase[Math.floor(Math.random()*symbolsBase.length)]; }
function getNumberSymbol(){ return String(Math.floor(Math.random()*9)+1); }

function girarRodillos(finalSymbols, onFinish){
  let spins=15, count=0;
  const interval = setInterval(()=>{
    cells.forEach((c,i)=>{
      c.textContent = (i<3)?getSymbol():getNumberSymbol();
    });
    count++;
    if(count>=spins){
      clearInterval(interval);
      cells.forEach((c,i)=>c.textContent=finalSymbols[i]);
      if(onFinish) onFinish();
    }
  },80);
}

// Evento girar
document.getElementById('spinBtn').addEventListener('click', ()=>{
  if(ultimoDia === hoy()){
    alert('Solo 1 tirada por dÃ­a.');
    return;
  }

  let s1,s2,s3,s4,esEspecial=false;

  function getSymbolControlled(prev){
    if(prev && Math.random() < 0.10){
      return prev;
    }
    let s; do { s=getSymbol(); } while(s===prev && ultimosDobles.filter(d=>d===s).length>=2);
    return s;
  }

  let a = getSymbol();
  let b = getSymbolControlled(a);
  let c = getSymbolControlled(b);
  s4 = getNumberSymbol();
  [s1,s2,s3] = [a,b,c];

  if(s1===s2 || s2===s3) ultimosDobles.push(s1===s2?s1:s2);
  if(ultimosDobles.length>5) ultimosDobles.shift();

  girarRodillos([s1,s2,s3,s4], ()=>{
    let combo = s1+s2+s3;
    let premioTexto="Sin premio", hayPremio=false;
    if(s1===s2 && s2===s3){ premioTexto = premios[combo]||"ğŸ‰ Ganaste!"; hayPremio=true; prob+=0.2; }
    else if(s1===s2){ premioTexto=premios[s1+s2]||"Premio doble!"; hayPremio=true; prob+=0.1; }
    else if(s2===s3){ premioTexto=premios[s2+s3]||"Premio doble!"; hayPremio=true; prob+=0.1; }
    else{ prob-=0.05; }
    prob = Math.min(Math.max(prob,0),100);
    racha++;
    ultimoDia = hoy();
    resultadoDiv.textContent=`${premioTexto} (N:${s4})`;
    resultadoDiv.className = hayPremio?'premio-verde':'premio-rojo';
    addHistorial(`Tirada: ${combo} | N:${s4} â€” ${premioTexto}`, esEspecial);
    actualizarEstado();
    guardar();
  });
});

// Video modal
const videoModal=document.getElementById('videoModal');
const videoEl=document.getElementById('videoEl');
const videoClose=document.getElementById('videoClose');
document.getElementById('verVideoBtn').addEventListener('click',()=>{
  videoModal.classList.add('show'); videoModal.setAttribute('aria-hidden','false');
  videoEl.currentTime=0; videoEl.play();
});
videoClose.addEventListener('click',()=>{
  videoEl.pause(); videoModal.classList.remove('show'); videoModal.setAttribute('aria-hidden','true');
});
videoEl.addEventListener('ended',()=>{
  videoModal.classList.remove('show'); videoModal.setAttribute('aria-hidden','true');
});
videoModal.addEventListener('click',(e)=>{ if(e.target===videoModal) videoClose.click(); });

// Tabla premios
const tablaModal=document.getElementById('tablaModal');
const tablaInner=document.getElementById('tablaPremiosInner');
const tablaClose=document.getElementById('tablaClose');
document.getElementById('verTablaBtn').addEventListener('click', ()=>{
  let html='<table><tr><th>CombinaciÃ³n</th><th>Premio</th></tr>';
  Object.entries(premios).forEach(([k,v])=>{ html+=`<tr><td>${k}</td><td>${v}</td></tr>`; });
  html+='</table>';
  tablaInner.innerHTML=html;
  tablaModal.classList.add('show'); tablaModal.setAttribute('aria-hidden','false');
});
tablaClose.addEventListener('click',()=>{ tablaModal.classList.remove('show'); tablaModal.setAttribute('aria-hidden','true'); });
tablaModal.addEventListener('click',(e)=>{ if(e.target===tablaModal) tablaClose.click(); });

// Reglas
document.getElementById('verReglasBtn').addEventListener('click',()=>{ alert("Reglas:\n- Solo 1 tirada por dÃ­a\n- Dobles limitados a 2 en 5 tiradas\n- Racha y probabilidad ajustables\n- Video aumenta +5%"); });

// Reiniciar
document.getElementById('reiniciarBtn').addEventListener('click',()=>{
  if(!confirm('Se reiniciarÃ¡ todo el progreso.')) return;
  historial=[]; prob=50; racha=0; ultimosDobles=[]; premiosEspecialesPost20=0; ultimoDia=''; ultimoVideoDia='';
  resultadoDiv.textContent='ğŸ‘‰ Esperando tirada...'; resultadoDiv.className='';
  renderHistorial(); actualizarPanelTest(); guardar();
});

// Exportar CSV
document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
  if(!historial || historial.length===0){ alert('No hay historial para exportar.'); return; }
  const headers = ['fecha','texto','especial'];
  const escape = s => `"${String(s).replace(/"/g,'""')}"`;
  const rows = historial.map(h=>[h.fecha,h.texto,h.especial?'1':'0']);
  let csv = '\uFEFF' + headers.map(escape).join(',') + '\n' + rows.map(r=>r.map(escape).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url;
  const d = new Date();
  a.download = `historial_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// Panel test mÃ³vil
document.getElementById('toggleTestBtn').addEventListener('click', ()=>{
  panelTest.style.display = panelTest.style.display==='none'?'block':'none';
});

// Inicializar
actualizarEstado(); renderHistorial(); actualizarPanelTest();
resultadoDiv.textContent='ğŸ‘‰ Esperando tirada...';

});
</script>
</body>
</html>
